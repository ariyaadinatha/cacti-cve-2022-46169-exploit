FROM alpine:3.15

RUN echo "http://dl-cdn.alpinelinux.org/alpine/v3.15/main" > /etc/apk/repositories
RUN echo "http://dl-cdn.alpinelinux.org/alpine/v3.15/community" >> /etc/apk/repositories
RUN echo "http://dl-cdn.alpinelinux.org/alpine/latest-stable/community" >> /etc/apk/repositories
RUN echo "http://dl-cdn.alpinelinux.org/alpine/latest-stable/main" >> /etc/apk/repositories

# Install required packages
RUN apk update && \
    apk add --no-cache apache2 php7 php7-apache2 php7-pear php7-gd php7-mysqli php7-session php7-snmp rrdtool net-snmp net-snmp-tools curl mysql-client && \
    rm -rf /var/cache/apk/*

# Download and extract Cacti 1.2.22
RUN curl -L https://github.com/Cacti/cacti/archive/refs/tags/release/1.2.22.tar.gz | tar zxvf -

# Move Cacti to Apache web directory
RUN mv cacti-release-1.2.22 /var/www/localhost/htdocs/cacti

# Set permissions on Cacti directory
RUN chown -R apache:apache /var/www/localhost/htdocs/cacti && \
    chmod -R 755 /var/www/localhost/htdocs/cacti

# Configure Apache to serve Cacti
COPY cacti.conf /etc/apache2/conf.d/

# Copy configuration file for Cacti
COPY config.php /var/www/localhost/htdocs/cacti/include/

# Start Apache web server
CMD ["/bin/sh", "-c", "/setup_cacti_db.sh && httpd -D FOREGROUND"]